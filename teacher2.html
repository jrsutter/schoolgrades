<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family:"Roboto",sans-serif; background:#f5f7fa; margin:0; padding:0; }
.container { max-width:1000px; margin:40px auto; background:white; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.1); padding:30px; }
h1 { text-align:center; color:#333; margin-bottom:20px; }
.controls { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-bottom:15px; }
input, select { padding:8px; border:1px solid #ccc; border-radius:6px; font-size:1em; }
button { padding:8px 14px; border:none; border-radius:6px; background:#4a90e2; color:white; font-weight:500; cursor:pointer; transition:0.3s; }
button:hover { background:#357ab8; }
table { width:100%; border-collapse:collapse; font-size:0.95em; margin-top:10px; }
th, td { padding:10px; border-bottom:1px solid #ddd; text-align:left; }
th { background:#4a90e2; color:white; }
tr:nth-child(even){background:#f9f9f9;}
.entry-count { text-align:right; margin-bottom:10px; color:#555; font-weight:500; }
.entry-count button { margin-left:10px; font-size:0.85em; }
</style>
</head>
<body>
<div class="container">
<h1>Teacher Dashboard</h1>

<div class="controls">
  <input type="text" id="studentCodeInput" placeholder="Set New Student Code">
  <button onclick="updateCode()">Set Code</button>
  <div>Current Code: <b id="currentCode">Loading...</b></div>
</div>

<div class="controls">
  <select id="unitSelect">
    <option value="Unit1">Unit 1</option>
    <option value="Unit2">Unit 2</option>
    <option value="Unit3">Unit 3</option>
  </select>
  <select id="hwSelect">
    <option value="HW1">Homework 1</option>
    <option value="HW2">Homework 2</option>
    <option value="HW3">Homework 3</option>
  </select>
  <button onclick="loadGrades()">Load Grades</button>
  <input type="text" id="csvNameInput" placeholder="CSV Filename">
  <button onclick="downloadCSV()">Download CSV</button>
  <button onclick="clearGrades()">Clear Grades</button>
  <button id="toggleColumnsBtn">Hide ID & Score</button>
</div>

<div class="entry-count">Total Entries: <span id="entryCount">0</span></div>

<table id="gradesTable">
<thead>
<tr>
<th>Timestamp</th>
<th>Class</th>
<th>StudentID</th>
<th>First Name</th>
<th>Last Name</th>
<th>Score</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzi91G6Jyt6bqovelepmOnbGEM6BYpFFEozhdVMr6aXGTAHPn6z85rzrYFRm5l-Vq4E/exec";
let columnsHidden = false;

async function fetchCode(){
  const res = await fetch(`${SCRIPT_URL}?action=getCode`);
  const data = await res.json();
  document.getElementById("currentCode").textContent = data.code || "Not Set";
}

async function updateCode(){
  const newCode = document.getElementById("studentCodeInput").value.trim();
  if(!newCode) return alert("Enter valid code.");
  await fetch(SCRIPT_URL, { method:"POST", body:JSON.stringify({ action:"setCode", code:newCode }) });
  fetchCode();
  alert("Code updated!");
}

async function loadGrades(){
  const unit = document.getElementById("unitSelect").value;
  const hw = document.getElementById("hwSelect").value;
  const res = await fetch(`${SCRIPT_URL}?action=getGrades&unit=${unit}&hw=${hw}`);
  const data = await res.json();
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML = "";
  data.forEach(row=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${row.Timestamp||""}</td><td>${row.Class||""}</td><td>${row.StudentID||""}</td><td>${row.FirstName||""}</td><td>${row.LastName||""}</td><td>${row.Score||""}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("entryCount").textContent = data.length;
}

async function downloadCSV(){
  const unit = document.getElementById("unitSelect").value;
  const hw = document.getElementById("hwSelect").value;
  const filename = document.getElementById("csvNameInput").value.trim() || `${unit}_${hw}.csv`;
  const res = await fetch(`${SCRIPT_URL}?action=downloadCSV&unit=${unit}&hw=${hw}`);
  const csv = await res.text();
  const blob = new Blob([csv], { type:"text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
  URL.revokeObjectURL(link.href);
}

async function clearGrades(){
  const unit = document.getElementById("unitSelect").value;
  const hw = document.getElementById("hwSelect").value;
  if(!confirm(`Clear all grades for ${unit} - ${hw}?`)) return;
  await fetch(`${SCRIPT_URL}?action=clearGrades&unit=${unit}&hw=${hw}`);
  loadGrades();
  alert("Grades cleared!");
}

function toggleColumns(hide){
  const table = document.getElementById("gradesTable");
  const colIndices = [2,5];
  for(let row of table.rows){
    for(let idx of colIndices){
      if(row.cells[idx]) row.cells[idx].style.display = hide ? "none" : "";
    }
  }
}
document.getElementById("toggleColumnsBtn").addEventListener("click",()=>{
  columnsHidden = !columnsHidden;
  toggleColumns(columnsHidden);
  document.getElementById("toggleColumnsBtn").textContent = columnsHidden ? "Show ID & Score" : "Hide ID & Score";
});

window.addEventListener("DOMContentLoaded", ()=>{
  fetchCode();
  loadGrades();
});
</script>
</body>
</html>
