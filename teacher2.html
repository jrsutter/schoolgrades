<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Teacher Dashboard</title>
  <style>
    body { font-family: Arial; background: #f9fafc; padding: 20px; }
    h1 { color: #1a73e8; text-align: center; }
    .controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; }
    select, input, button { padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
    button { background: #1a73e8; color: white; cursor: pointer; }
    button:hover { background: #155fc4; }
    #refreshCircle { width: 15px; height: 15px; border-radius: 50%; display: inline-block; margin-left: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #e8f0fe; }
  </style>
</head>
<body>
  <h1>Teacher Dashboard</h1>
  <div class="controls">
    <select id="unit"><option value="">Unit</option></select>
    <select id="homework"><option value="">Homework</option></select>
    <select id="classFilter"><option value="">Class</option></select>
    <button id="refresh">Refresh</button>
    <button id="toggle">Hide ID & Score</button>
    <input id="csvName" placeholder="CSV file name">
    <button id="download">Download CSV</button>
  </div>

  <div class="controls">
    <label>Current Code:</label> <span id="currentCode">Loading...</span>
    <input id="newCode" placeholder="New code">
    <button id="setCode">Set New Code</button>
    <div id="refreshCircle" style="background:red;"></div>
  </div>

  <table id="gradesTable"><thead></thead><tbody></tbody></table>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzi91G6Jyt6bqovelepmOnbGEM6BYpFFEozhdVMr6aXGTAHPn6z85rzrYFRm5l-Vq4E/exec"; // Replace this

    const units = ["Unit 1","Unit 2","Unit 3A","Unit 3B","Unit 4A","Unit 4B","Unit 5A","Unit 5B","Unit 6","Unit 7A","Unit 7B","Unit 8"];
    const hws = ["HW1","HW2","HW3","HW4","HW5","HW6","HW7","HW8"];
    const classes = ["1","2","3","4","5","6","7"];

    units.forEach(u => unit.innerHTML += `<option>${u}</option>`);
    hws.forEach(h => homework.innerHTML += `<option>${h}</option>`);
    classes.forEach(c => classFilter.innerHTML += `<option>${c}</option>`);

    let hide = false;

    async function loadGrades() {
      if (!unit.value || !homework.value) return;
      refreshCircle.style.background = refreshCircle.style.background === "red" ? "green" : "red";

      const payload = {
        action: "getGrades",
        unit: unit.value,
        homework: homework.value,
        classFilter: classFilter.value
      };

      const res = await fetch(SCRIPT_URL, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(payload)});
      const data = await res.json();
      if (!data.success) return alert("Error: " + data.message);

      const rows = data.data;
      if (!rows.length) { gradesTable.innerHTML = "<tr><td>No data</td></tr>"; return; }

      const headers = ["Timestamp","ID","First Name","Last Name","Class","Score"];
      gradesTable.querySelector("thead").innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr>`;
      gradesTable.querySelector("tbody").innerHTML = rows.map(r => 
        `<tr>${r.map((v,i)=> hide && (i===1||i===5) ? "<td>Hidden</td>" : `<td>${v}</td>`).join("")}</tr>`
      ).join("");
    }

    refresh.onclick = loadGrades;
    toggle.onclick = () => { hide=!hide; loadGrades(); };

    download.onclick = () => {
      if (!gradesTable.querySelector("tbody").innerHTML) return alert("No data");
      const name = csvName.value || "grades";
      let csv = "";
      document.querySelectorAll("table tr").forEach(row=>{
        let cols = [...row.querySelectorAll("th,td")].map(c=>c.innerText.replace(/,/g,""));
        csv += cols.join(",") + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = name + ".csv"; a.click();
    };

    setInterval(loadGrades, 5000); // auto refresh every 5 sec

    // Load and update code
    setCode.onclick = async () => {
      if (!newCode.value) return;
      const res = await fetch(SCRIPT_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ action:"updateCode", newCode:newCode.value })
      });
      const data = await res.json();
      currentCode.textContent = data.code;
      newCode.value = "";
    };
  </script>
</body>
</html>
