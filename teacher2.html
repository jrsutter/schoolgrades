<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>
<style>
body { font-family:'Segoe UI', sans-serif; background:#f0f2f5; }
.container { max-width:1200px; margin:30px auto; padding:20px; background:white; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
select, input, button { padding:8px; margin:5px; border-radius:5px; border:1px solid #ccc;}
button { background:#1a73e8; color:white; border:none; cursor:pointer; }
button:hover { background:#1669c1; }
#statusCircle { display:inline-block; width:15px; height:15px; border-radius:50%; margin-left:10px; vertical-align:middle; background:red;}
table { width:100%; border-collapse:collapse; margin-top:15px;}
th, td { border:1px solid #ccc; padding:8px; text-align:center;}
</style>
</head>
<body>
<div class="container">
<h2>Teacher Dashboard <span id="statusCircle"></span></h2>

<label>Unit:</label><select id="unitSelect"><option>Unit 1</option><option>Unit 2</option><option>Unit 3A</option><option>Unit 3B</option><option>Unit 4A</option><option>Unit 4B</option><option>Unit 5A</option><option>Unit 5B</option><option>Unit 6</option><option>Unit 7A</option><option>Unit 7B</option><option>Unit 8</option></select>
<label>Homework:</label><select id="hwSelect"><option>HW1</option><option>HW2</option><option>HW3</option><option>HW4</option><option>HW5</option><option>HW6</option><option>HW7</option><option>HW8</option></select>
<label>Class Filter:</label><input type="text" id="classFilter" placeholder="Optional class filter">
<label>Hide ID/Score:</label><input type="checkbox" id="hideColumns">
<button id="refreshBtn">Refresh</button>

<br><label>CSV Filename:</label><input type="text" id="csvName" placeholder="grades.csv">
<button id="downloadBtn">Download CSV</button>

<br><label>Current Student Code:</label>
<input type="text" id="currentCode" readonly>
<label>Set New Student Code:</label><input type="text" id="newCode">
<button id="updateCodeBtn">Update Code</button>

<table id="gradesTable"><thead></thead><tbody></tbody></table>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzi91G6Jyt6bqovelepmOnbGEM6BYpFFEozhdVMr6aXGTAHPn6z85rzrYFRm5l-Vq4E/exec";
const statusCircle = document.getElementById("statusCircle");
let flashState=false;

async function fetchGrades(){
  const payload={ action:"getGrades",
                  unit:document.getElementById("unitSelect").value,
                  homework:document.getElementById("hwSelect").value,
                  classFilter:document.getElementById("classFilter").value };
  try{
    const res=await fetch(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const data=await res.json();
    if(data.success) buildTable(data.headers,data.data);
  }catch{console.log("Server error");}
}

function buildTable(headers,rows){
  const hideCols=document.getElementById("hideColumns").checked;
  const table=document.getElementById("gradesTable");
  table.innerHTML="";
  const thead=document.createElement("thead");
  const tr=document.createElement("tr");
  headers.forEach((h,i)=>{
    if(hideCols && (h==="Student ID"||h==="Score")) return;
    const th=document.createElement("th"); th.textContent=h; tr.appendChild(th);
  });
  thead.appendChild(tr);
  table.appendChild(thead);
  const tbody=document.createElement("tbody");
  rows.forEach(r=>{
    const tr=document.createElement("tr");
    r.forEach((c,i)=>{
      if(hideCols && (headers[i]==="Student ID"||headers[i]==="Score")) return;
      const td=document.createElement("td"); td.textContent=c; tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
}

// Flashing indicator
setInterval(()=>{ flashState=!flashState; statusCircle.style.background=flashState?"green":"red"; },500);

// Load current student code
async function loadCurrentCode() {
  try {
    const res = await fetch(SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getCurrentCode"})});
    const data = await res.json();
    if(data.success) document.getElementById("currentCode").value = data.code;
  } catch(err){ console.log("Error fetching current code:", err); }
}
loadCurrentCode();

// Refresh
document.getElementById("refreshBtn").addEventListener("click", fetchGrades);

// CSV download
document.getElementById("downloadBtn").addEventListener("click", ()=>{
  const table=document.getElementById("gradesTable");
  let csv="";
  for(let r of table.rows){
    let row=[];
    for(let c of r.cells) row.push(c.textContent);
    csv+=row.join(",")+"\n";
  }
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=document.getElementById("csvName").value||"grades.csv";
  a.click();
});

// Update student code
document.getElementById("updateCodeBtn").addEventListener("click", async ()=>{
  const code=document.getElementById("newCode").value.trim();
  if(!code) return;
  try{
    const res=await fetch(SCRIPT_URL,{method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"updateCode", newCode:code})});
    const data=await res.json();
    if(data.success){
      alert("Student code updated: "+data.code);
      document.getElementById("currentCode").value = data.code;
    } else alert("Error: "+data.message);
  }catch{alert("Server error");}
});
</script>
</body>
</html>
