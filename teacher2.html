<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f3f3f3;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
  }
  #controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
  }
  #controls > div {
    margin: 5px 10px;
  }
  button {
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
  }
  button:hover {
    background: #0056b3;
  }
  select, input[type="text"] {
    padding: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }
  th {
    background: #007bff;
    color: white;
  }
  #entriesCount {
    font-weight: bold;
  }
  #dot {
    height: 10px;
    width: 10px;
    border-radius: 50%;
    background: red;
    display: inline-block;
    margin-left: 10px;
  }
</style>
</head>
<body>

<h1>Teacher Dashboard</h1>

<div id="controls">
  <div>
    <label><b>Student Code:</b></label>
    <span id="studentCode">Loading...</span>
    <input type="text" id="newCode" placeholder="Enter new code">
    <button onclick="setStudentCode()">Set Code</button>
  </div>
  <div>
    <label><b>Rename CSV:</b></label>
    <input type="text" id="csvName" placeholder="Grades Filename">
    <button onclick="downloadCSV()">Download CSV</button>
  </div>
  <div>
    <label><b>Filter Class:</b></label>
    <select id="classFilter" onchange="filterClass()">
      <option value="All">All Classes</option>
    </select>
  </div>
  <div>
    <button onclick="toggleColumns()">Hide ID & Score</button>
  </div>
  <div id="entriesCount">Entries: 0</div>
  <div id="dot"></div>
</div>

<table id="gradesTable">
  <thead>
    <tr>
      <th>Student ID</th>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Class</th>
      <th>Assignment</th>
      <th>Score</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<br>
<button style="background:#dc3545;" onclick="clearGrades()">Clear All Grades</button>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPZmQPtthZ-pDI0ayvSiO3_-w9u7nLScIZQtg1JILhrwu77N9CJeYoGGQeNY4HePVvNQ/exec";

let allGrades = [];
let hideColumns = false;
let dotState = false;

async function fetchStudentCode() {
  const res = await fetch(`${SCRIPT_URL}?action=getStudentCode`);
  const data = await res.json();
  document.getElementById('studentCode').textContent = data.code;
}

async function setStudentCode() {
  const newCode = document.getElementById('newCode').value.trim();
  if (!newCode) return alert("Please enter a code.");
  await fetch(`${SCRIPT_URL}?action=setStudentCode&code=${encodeURIComponent(newCode)}`);
  alert("Student code updated!");
  fetchStudentCode();
}

async function fetchGrades() {
  const res = await fetch(`${SCRIPT_URL}?action=getGrades`);
  const data = await res.json();
  allGrades = data;
  populateTable(data);
  updateClassDropdown(data);
}

function populateTable(data) {
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML = "";
  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.studentId}</td>
      <td>${row.firstName}</td>
      <td>${row.lastName}</td>
      <td>${row.className}</td>
      <td>${row.assignment}</td>
      <td>${row.score}</td>
      <td>${row.timestamp}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById("entriesCount").textContent = `Entries: ${data.length}`;
}

function updateClassDropdown(data) {
  const dropdown = document.getElementById("classFilter");
  const classes = [...new Set(data.map(d => d.className))].filter(Boolean);
  dropdown.innerHTML = '<option value="All">All Classes</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
}

function filterClass() {
  const selectedClass = document.getElementById("classFilter").value;
  const filtered = selectedClass === "All" ? allGrades : allGrades.filter(d => d.className === selectedClass);
  populateTable(filtered);
}

function toggleColumns() {
  const table = document.getElementById("gradesTable");
  hideColumns = !hideColumns;
  const display = hideColumns ? "none" : "";
  for (let row of table.rows) {
    row.cells[0].style.display = display; // student ID
    row.cells[5].style.display = display; // score
  }
}

function downloadCSV() {
  const csvName = document.getElementById("csvName").value || "Grades";
  let csv = "Student ID,First Name,Last Name,Class,Assignment,Score,Timestamp\n";
  allGrades.forEach(r => {
    csv += `${r.studentId},${r.firstName},${r.lastName},${r.className},${r.assignment},${r.score},${r.timestamp}\n`;
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${csvName}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

async function clearGrades() {
  if (!confirm("Are you sure you want to clear all grades?")) return;
  await fetch(`${SCRIPT_URL}?action=clearGrades`);
  await fetchGrades();
  alert("Grades cleared.");
}

setInterval(() => {
  dotState = !dotState;
  document.getElementById("dot").style.backgroundColor = dotState ? "green" : "red";
  fetchGrades();
}, 1000);

window.addEventListener("DOMContentLoaded", () => {
  fetchStudentCode();
  fetchGrades();
});
</script>

</body>
</html>
