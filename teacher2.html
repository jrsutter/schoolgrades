<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Roboto', sans-serif;
    background: #f3f4f6;
    margin: 0;
    padding: 20px;
  }
  h2 { text-align: center; color: #333; }
  .card {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    max-width: 900px;
    margin: 20px auto;
  }
  button {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover { background: #0056b3; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }
  th {
    background: #007bff;
    color: white;
  }
  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
  }
  .code-section input {
    width: 100px;
    margin-left: 6px;
  }
  .filter-controls {
    display: flex;
    align-items: center;
    gap: 10px;
  }
</style>
</head>
<body>

<h2>Teacher Dashboard</h2>

<div class="card">
  <div class="top-bar">
    <div class="code-section">
      <label>Student Code:</label>
      <span id="currentCode" style="font-weight: 500;">Loading...</span>
      <input type="text" id="newCodeInput" placeholder="New code">
      <button onclick="setNewCode()">Set Code</button>
    </div>
    <div class="filter-controls">
      <label for="classFilter">Filter Class:</label>
      <select id="classFilter" onchange="filterClass()">
        <option value="All">All</option>
      </select>
      <button onclick="toggleColumns()">Hide/Show Columns</button>
      <span id="entryCount" style="font-weight: 500;">Entries: 0</span>
    </div>
  </div>

  <div style="margin-top:10px;">
    <input type="text" id="csvNameInput" placeholder="File name (optional)">
    <button onclick="downloadCSV()">Download CSV</button>
    <button onclick="clearGrades()">Clear Grades</button>
  </div>

  <table id="gradesTable">
    <thead>
      <tr>
        <th class="col-studentId">Student ID</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Class</th>
        <th>Assignment</th>
        <th class="col-score">Score</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPZmQPtthZ-pDI0ayvSiO3_-w9u7nLScIZQtg1JILhrwu77N9CJeYoGGQeNY4HePVvNQ/exec"; // Replace with your actual deployed Apps Script URL
let hideColumns = false;
let allGrades = [];

// ---------- INITIAL LOAD ----------
window.onload = async () => {
  await loadStudentCode();
  await loadGrades();
};

// ---------- STUDENT CODE ----------
async function loadStudentCode() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getStudentCode`);
    const data = await res.json();
    document.getElementById("currentCode").textContent = data.code || "(none)";
  } catch (err) {
    console.error("Error loading code:", err);
    document.getElementById("currentCode").textContent = "Error";
  }
}

async function setNewCode() {
  const code = document.getElementById("newCodeInput").value.trim();
  if (!code) return alert("Enter a new code");
  try {
    await fetch(`${SCRIPT_URL}?action=setStudentCode&code=${encodeURIComponent(code)}`);
    document.getElementById("newCodeInput").value = "";
    await loadStudentCode();
    alert("Student code updated!");
  } catch (err) {
    console.error(err);
    alert("Failed to set code");
  }
}

// ---------- GRADES TABLE ----------
async function loadGrades() {
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getGrades`);
    const data = await res.json();
    allGrades = data;

    const classSet = new Set(["All"]);
    data.forEach(row => { if (row.className) classSet.add(row.className); });
    const filterSelect = document.getElementById("classFilter");
    filterSelect.innerHTML = "";
    classSet.forEach(cls => {
      const opt = document.createElement("option");
      opt.value = cls;
      opt.textContent = cls;
      filterSelect.appendChild(opt);
    });

    renderTable(data);
  } catch (err) {
    console.error("Error loading grades:", err);
  }
}

function renderTable(data) {
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML = "";
  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="col-studentId">${row.studentId}</td>
      <td>${row.firstName}</td>
      <td>${row.lastName}</td>
      <td>${row.className}</td>
      <td>${row.assignment}</td>
      <td class="col-score">${row.score}</td>
      <td>${row.timestamp}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById("entryCount").textContent = `Entries: ${data.length}`;
}

// ---------- FILTER BY CLASS ----------
function filterClass() {
  const selected = document.getElementById("classFilter").value;
  const filtered = selected === "All" ? allGrades : allGrades.filter(r => r.className === selected);
  renderTable(filtered);
}

// ---------- HIDE/SHOW COLUMNS ----------
function toggleColumns() {
  hideColumns = !hideColumns;
  const idCols = document.querySelectorAll(".col-studentId");
  const scoreCols = document.querySelectorAll(".col-score");
  idCols.forEach(col => col.style.display = hideColumns ? "none" : "");
  scoreCols.forEach(col => col.style.display = hideColumns ? "none" : "");
}

// ---------- DOWNLOAD CSV ----------
function downloadCSV() {
  if (!allGrades.length) return alert("No data to download.");
  const name = document.getElementById("csvNameInput").value.trim() || "grades";
  let csv = "Student ID,First Name,Last Name,Class,Assignment,Score,Timestamp\n";
  allGrades.forEach(r => {
    csv += `${r.studentId},${r.firstName},${r.lastName},${r.className},${r.assignment},${r.score},${r.timestamp}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `${name}.csv`;
  link.click();
}

// ---------- CLEAR GRADES ----------
async function clearGrades() {
  if (!confirm("Clear all grades?")) return;
  try {
    const res = await fetch(`${SCRIPT_URL}?action=clearGrades`);
    const data = await res.json();
    if (data.success) {
      allGrades = [];
      renderTable([]);
      alert("Grades cleared!");
    }
  } catch (err) {
    console.error(err);
    alert("Failed to clear grades");
  }
}
</script>

</body>
</html>
