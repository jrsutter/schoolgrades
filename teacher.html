<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Tools</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family:"Roboto",sans-serif; background:#f5f7fa; margin:0; padding:0; }
.container { max-width:900px; margin:50px auto; background:white; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.1); padding:30px 40px; }
h1 { text-align:center; color:#333; margin-bottom:20px; }
.status-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
.dot { height:16px; width:16px; border-radius:50%; background:red; transition:0.4s; }
.code-box { font-size:1.8em; font-weight:700; color:#333; background:#e9eef5; border-radius:8px; padding:10px 20px; display:inline-block; }
.controls { display:flex; gap:15px; flex-wrap:wrap; justify-content:center; margin-bottom:15px; }
input[type="text"], select { padding:10px; border-radius:6px; border:1px solid #ccc; width:200px; font-size:1em; }
button { padding:10px 16px; border:none; border-radius:6px; background:#4a90e2; color:white; cursor:pointer; font-weight:500; transition:0.3s; }
button:hover { background:#357ab8; }
table { width:100%; border-collapse:collapse; font-size:0.95em; margin-top:10px; }
th,td { text-align:left; padding:12px; }
th { background:#4a90e2; color:white; position:sticky; top:0; }
tr:nth-child(even){background:#f2f2f2;}
tr:hover{background:#e8f0fe;}
.entry-count { text-align:right; margin-bottom:10px; color:#555; font-weight:500; display:flex; justify-content:flex-end; align-items:center; gap:10px; flex-wrap:wrap; }
.entry-count button { background:#4a90e2; color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer; font-size:0.85em; }
.entry-count button:hover { background:#357ab8; }
</style>
</head>
<body>
<div class="container">
<h1>Teacher Tools</h1>

<div class="status-bar">
  <div class="code-box">Student Code: <span id="studentCodeDisplay">Loading...</span></div>
  <div class="dot" id="updateDot"></div>
</div>

<div class="controls">
  <input type="text" id="studentCodeInput" placeholder="Set New Student Code">
  <button onclick="updateStudentCode()">Set Code</button>
  <input type="text" id="csvNameInput" placeholder="CSV Filename">
  <button onclick="downloadCSV()">Download CSV</button>
  <button onclick="clearGrades()">Clear Grades</button>
</div>

<div class="entry-count">
  <label for="classFilter">Filter Class:</label>
  <select id="classFilter">
    <option value="all">All Classes</option>
    <option value="1st">1st</option>
    <option value="3rd">3rd</option>
    <option value="4th">4th</option>
    <option value="5th">5th</option>
    <option value="6th">6th</option>
    <option value="7th">7th</option>
  </select>
  <span>Total Entries: <span id="entryCount">0</span></span>
  <button id="toggleColumnsBtn">Hide ID & Score</button>
</div>

<table id="gradesTable">
<thead>
<tr>
<th>Timestamp</th>
<th>Class</th>
<th>StudentID</th>
<th>First Name</th>
<th>Last Name</th>
<th>Score</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPZmQPtthZ-pDI0ayvSiO3_-w9u7nLScIZQtg1JILhrwu77N9CJeYoGGQeNY4HePVvNQ/exec";
const dot = document.getElementById("updateDot");
let dotState = false;
let columnsHidden = false;
const toggleBtn = document.getElementById("toggleColumnsBtn");
const classFilter = document.getElementById("classFilter");

// --------------------- Fetch Student Code ---------------------
async function fetchStudentCode(){
  try{
    const res = await fetch(`${SCRIPT_URL}?action=getCode`);
    const data = await res.json();
    document.getElementById("studentCodeDisplay").textContent = data.code || "Not Set";
  }catch(err){
    console.error(err);
    document.getElementById("studentCodeDisplay").textContent="Error";
  }
}

// --------------------- Update Student Code ---------------------
async function updateStudentCode(){
  const newCode = document.getElementById("studentCodeInput").value.trim();
  if(!newCode) return alert("Enter a valid student code.");
  try{
    const payload = { action:"setCode", code:newCode };
    const res = await fetch(SCRIPT_URL, { method:"POST", body:JSON.stringify(payload) });
    const data = await res.json();
    if(data.success){
      document.getElementById("studentCodeDisplay").textContent=newCode;
      alert("Student code updated!");
    } else alert("Failed to update code");
  }catch(err){ console.error(err); alert("Error updating code"); }
}

// --------------------- Fetch Grades ---------------------
async function fetchGrades(){
  try{
    const res = await fetch(`${SCRIPT_URL}?action=getGrades`);
    const data = await res.json();

    const tbody = document.querySelector("#gradesTable tbody");
    tbody.innerHTML = "";

    // Determine selected class
    const selectedClass = classFilter.value;

    // Filter rows if necessary and handle both array or object formats
    const filteredData = data.filter(r => {
      const classVal = Array.isArray(r) ? r[1] : r.Class;
      return selectedClass === "all" || classVal === selectedClass;
    });

    filteredData.forEach(row => {
      let t, c, id, f, l, s;
      if (Array.isArray(row)) {
        [t, c, id, f, l, s] = row;
      } else {
        ({ Timestamp: t, Class: c, StudentID: id, FirstName: f, LastName: l, Score: s } = row);
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t || ""}</td>
        <td>${c || ""}</td>
        <td>${id || ""}</td>
        <td>${f || ""}</td>
        <td>${l || ""}</td>
        <td>${s || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("entryCount").textContent = filteredData.length;

    // Apply column toggle if active
    if(columnsHidden) toggleColumns(true);
  }catch(err){ console.error(err); }
}

// --------------------- Download CSV ---------------------
async function downloadCSV(){
  const filename = document.getElementById("csvNameInput").value.trim() || "grades.csv";
  try{
    const res = await fetch(`${SCRIPT_URL}?action=downloadCSV`);
    const csv = await res.text();
    const blob = new Blob([csv], { type:"text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    URL.revokeObjectURL(link.href);
  }catch(err){ alert("Failed to download CSV: "+err); }
}

// --------------------- Clear Grades ---------------------
async function clearGrades(){
  if(!confirm("Are you sure you want to clear all grades?")) return;
  await fetch(`${SCRIPT_URL}?action=clearGrades`);
  await fetchGrades();
  alert("Grades cleared.");
}

// --------------------- Toggle Columns ---------------------
function toggleColumns(hide){
  const table = document.getElementById("gradesTable");
  const colIndices = [2,5]; // StudentID and Score
  for(let row of table.rows){
    for(let idx of colIndices){
      if(row.cells[idx]) row.cells[idx].style.display = hide ? "none" : "";
    }
  }
}

toggleBtn.addEventListener("click", ()=>{
  columnsHidden = !columnsHidden;
  toggleColumns(columnsHidden);
  toggleBtn.textContent = columnsHidden ? "Show ID & Score" : "Hide ID & Score";
});

// --------------------- Filter Class ---------------------
classFilter.addEventListener("change", fetchGrades);

// --------------------- Refresh Dot & Table ---------------------
setInterval(()=>{
  dotState = !dotState;
  dot.style.backgroundColor = dotState ? "green" : "red";
  fetchGrades();
}, 1000);

// --------------------- Initial Load ---------------------
window.addEventListener("DOMContentLoaded", ()=>{
  fetchStudentCode();
  fetchGrades();
});
</script>
</body>
</html>
