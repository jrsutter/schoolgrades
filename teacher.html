<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Tools</title>
<style>
/* Basic styling (same as before) */
body { font-family: Arial,sans-serif; margin:0;padding:0; background:#f5f7fa;}
.container{max-width:900px;margin:50px auto;background:#fff;padding:30px;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,0.1);}
h1{text-align:center;margin-bottom:20px;}
.status-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;}
.dot{height:16px;width:16px;border-radius:50%;background-color:red;transition:background-color 0.4s;}
.code-box{font-weight:700;background:#e9eef5;padding:10px 20px;border-radius:8px;}
.controls{display:flex;gap:10px;margin-bottom:25px;}
input, button{padding:10px;border-radius:6px;border:1px solid #ccc;}
button{background:#4a90e2;color:#fff;cursor:pointer;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:12px;text-align:left;}
th{background:#4a90e2;color:#fff;}
tr:nth-child(even){background:#f2f2f2;}
tr:hover{background:#e8f0fe;}
.entry-count{text-align:right;margin-top:10px;color:#555;}
</style>
</head>
<body>
<div class="container">
<h1>Teacher Tools</h1>

<div class="status-bar">
  <div class="code-box">Student Code: <span id="studentCodeDisplay">Loading...</span></div>
  <div class="dot" id="updateDot"></div>
</div>

<div class="controls">
  <input type="text" id="studentCodeInput" placeholder="Set New Student Code">
  <button onclick="updateStudentCode()">Set Code</button>
  <input type="text" id="csvNameInput" placeholder="CSV Filename">
  <button onclick="downloadCSV()">Download CSV</button>
  <button onclick="clearGrades()">Clear Grades</button>
</div>

<table id="gradesTable">
  <thead>
    <tr>
      <th>Timestamp</th><th>Class</th><th>Student ID</th><th>First Name</th><th>Last Name</th><th>Score</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="entry-count">
  Total Entries: <span id="entryCount">0</span>
</div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPZmQPtthZ-pDI0ayvSiO3_-w9u7nLScIZQtg1JILhrwu77N9CJeYoGGQeNY4HePVvNQ/exec";
const dot = document.getElementById("updateDot");
let dotState = false;

async function fetchStudentCode(){
  const res = await fetch(`${SCRIPT_URL}?action=getCode`);
  const data = await res.json();
  document.getElementById("studentCodeDisplay").textContent = data.code||"Not Set";
}

async function updateStudentCode(){
  const newCode = document.getElementById("studentCodeInput").value.trim();
  if(!newCode) return alert("Enter code");
  const res = await fetch(`${SCRIPT_URL}?action=setCode&code=${encodeURIComponent(newCode)}`);
  const data = await res.json();
  if(data.success){ document.getElementById("studentCodeDisplay").textContent=newCode; alert("Code updated"); }
  else alert("Failed to update code");
}

async function fetchGrades(){
  const res = await fetch(`${SCRIPT_URL}?action=getGrades`);
  const data = await res.json();
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML="";
  data.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.Timestamp||""}</td><td>${r.Class||""}</td><td>${r.StudentID||""}</td><td>${r.FirstName||""}</td><td>${r.LastName||""}</td><td>${r.Score||""}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById("entryCount").textContent=data.length;
}

async function downloadCSV(){
  const filename=document.getElementById("csvNameInput").value.trim()||"grades.csv";
  const res=await fetch(`${SCRIPT_URL}?action=downloadCSV`);
  const csv=await res.text();
  const blob=new Blob([csv],{type:"text/csv"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download=filename;
  link.click();
  URL.revokeObjectURL(link.href);
}

async function clearGrades(){
  if(!confirm("Clear all grades?")) return;
  await fetch(`${SCRIPT_URL}?action=clearGrades`);
  await fetchGrades();
  alert("Grades cleared");
}

setInterval(()=>{ dotState=!dotState; dot.style.backgroundColor=dotState?"green":"red"; fetchGrades(); },500);
fetchStudentCode(); fetchGrades();
</script>
</body>
</html>
